---
layout: post
title: "MariaDBå´©æºƒåˆ†æ/Wordpressæ”¹ç”¨Nginx"
date: 2018-03-20
categories: 
---
> 2018å¹´3æœˆ20æ—¥ é˜´ ä¸€èˆ¬

# MariaDBå´©æºƒåˆ†æ/åšå®¢æ”¹ç”¨Nginx

> æœ€è¿‘SBå“¥ä»¬åœ¨æˆ‘æœåŠ¡å™¨ä¸Šé¢åš`hadoop`å®éªŒ, ç»“æœæå¾—æˆ‘åšå®¢æ€»æ˜¯å´©æºƒ, ä¹‹å‰ä»¥ä¸ºæ˜¯å¶ç„¶ç°è±¡æˆ–è€…æ˜¯è¢«æ”»å‡», ç›®å‰çœ‹æ¥æ˜¯æœåŠ¡å™¨é…ç½®ä½äº†ğŸ˜­, æ¯•ç«Ÿæ˜¯ç™½èœæœåŠ¡å™¨.

## åšå®¢å´©æºƒä¿®å¤å°ç»“

æ˜¨å¤©å¾ˆå¿™, ä¸€ç›´åœ¨å¤„ç†å¾®ä¿¡æˆæƒçš„é€»è¾‘åˆç†æ€§å’Œä½“éªŒ, å°½æ—©å‘ç°åšå®¢åˆæŒ‚äº†, åˆæ­¥æ£€æµ‹æ˜¯MariaDBæŒ‚äº†, åŸå› å°šä¸æ˜ç¡®.

### é‡å¯MariaDBæœåŠ¡, æ¢å¤æ•°æ®åº“çš„è¿æ¥

å…ˆæ£€æŸ¥çŠ¶æ€, ç¡®è®¤æ˜¯MariaDBå´©æºƒåé‡å¯æœåŠ¡

```bash
[root@VM_0_3_centos ~]# systemctl status mariadb
â— mariadb.service - MariaDB database server
   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; enabled; vendor preset: disabled)
   Active: inactive (dead) since Tue 2018-03-20 14:03:14 CST; 1h 39min ago
  Process: 4096 ExecStartPost=/usr/libexec/mariadb-wait-ready $MAINPID (code=exited, status=0/SUCCESS)
  Process: 4095 ExecStart=/usr/bin/mysqld_safe --basedir=/usr (code=exited, status=0/SUCCESS)
  Process: 4063 ExecStartPre=/usr/libexec/mariadb-prepare-db-dir %n (code=exited, status=0/SUCCESS)
 Main PID: 4095 (code=exited, status=0/SUCCESS)

Mar 20 08:26:25 VM_0_3_centos systemd[1]: Starting MariaDB database server...
Mar 20 08:26:26 VM_0_3_centos mariadb-prepare-db-dir[4063]: Database MariaDB is probably initial....
Mar 20 08:26:26 VM_0_3_centos mysqld_safe[4095]: 180320 08:26:26 mysqld_safe Logging to '/var/...g'.
Mar 20 08:26:26 VM_0_3_centos mysqld_safe[4095]: 180320 08:26:26 mysqld_safe Starting mysqld d...sql
Mar 20 08:26:28 VM_0_3_centos systemd[1]: Started MariaDB database server.
Hint: Some lines were ellipsized, use -l to show in full.
[root@VM_0_3_centos ~]# systemctl restart mariadb
```

è¾“å…¥å¯†ç åé‡æ–°æ£€æŸ¥æœåŠ¡æ˜¯å¦OK

```bash
[root@VM_0_3_centos ~]# systemctl status mariadb
â— mariadb.service - MariaDB database server
   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2018-03-20 15:45:26 CST; 21s ago
  Process: 19840 ExecStartPost=/usr/libexec/mariadb-wait-ready $MAINPID (code=exited, status=0/SUCCESS)
  Process: 19809 ExecStartPre=/usr/libexec/mariadb-prepare-db-dir %n (code=exited, status=0/SUCCESS)
 Main PID: 19839 (mysqld_safe)
   CGroup: /system.slice/mariadb.service
           â”œâ”€19839 /bin/sh /usr/bin/mysqld_safe --basedir=/usr
           â””â”€20003 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/...

Mar 20 15:45:23 VM_0_3_centos systemd[1]: Starting MariaDB database server...
Mar 20 15:45:23 VM_0_3_centos mariadb-prepare-db-dir[19809]: Database MariaDB is probably initia....
Mar 20 15:45:24 VM_0_3_centos mysqld_safe[19839]: 180320 15:45:24 mysqld_safe Logging to '/var/...'.
Mar 20 15:45:24 VM_0_3_centos mysqld_safe[19839]: 180320 15:45:24 mysqld_safe Starting mysqld d...ql
Mar 20 15:45:26 VM_0_3_centos systemd[1]: Started MariaDB database server.
Hint: Some lines were ellipsized, use -l to show in full.
```

ç„¶ååˆ·æ–°ç«™ç‚¹, å°±æ¢å¤äº†.

### æ£€æŸ¥MariaDBæ—¥å¿—

å¦ä¸€æ–¹é¢æŸ¥çœ‹MariaDBæ—¥å¿—, éƒ¨åˆ†æ—¥å¿—å¦‚ä¸‹:

```bash
180320 13:30:01 [Note] /usr/libexec/mysqld: ready for connections.
Version: '5.5.56-MariaDB'  socket: '/var/lib/mysql/mysql.sock'  port: 3306  MariaDB Server
180320 13:30:27 [ERROR] mysqld: Table './whidy/wp_options' is marked as crashed and should be repaired
180320 13:30:27 [Warning] Checking table:   './whidy/wp_options'
180320 14:03:10 mysqld_safe mysqld restarted
180320 14:03:13 [Note] /usr/libexec/mysqld (mysqld 5.5.56-MariaDB) starting as process 32158 ...
180320 14:03:13 InnoDB: The InnoDB memory heap is disabled
180320 14:03:13 InnoDB: Mutexes and rw_locks use GCC atomic builtins
180320 14:03:13 InnoDB: Compressed tables use zlib 1.2.7
180320 14:03:13 InnoDB: Using Linux native AIO
180320 14:03:13 InnoDB: Initializing buffer pool, size = 128.0M
InnoDB: mmap(137756672 bytes) failed; errno 12
180320 14:03:13 InnoDB: Completed initialization of buffer pool
180320 14:03:13 InnoDB: Fatal error: cannot allocate memory for the buffer pool
180320 14:03:13 [ERROR] Plugin 'InnoDB' init function returned error.
180320 14:03:13 [ERROR] Plugin 'InnoDB' registration as a STORAGE ENGINE failed.
180320 14:03:13 [ERROR] mysqld: Out of memory (Needed 128917504 bytes)
180320 14:03:13 [Note] Plugin 'FEEDBACK' is disabled.
180320 14:03:13 [ERROR] Unknown/unsupported storage engine: InnoDB
180320 14:03:13 [ERROR] Aborting

180320 14:03:14 [Note] /usr/libexec/mysqld: Shutdown complete

180320 14:03:14 mysqld_safe mysqld from pid file /var/run/mariadb/mariadb.pid ended
180320 15:45:24 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
180320 15:45:24 [Note] /usr/libexec/mysqld (mysqld 5.5.56-MariaDB) starting as process 20003 ...
180320 15:45:24 InnoDB: The InnoDB memory heap is disabled
180320 15:45:24 InnoDB: Mutexes and rw_locks use GCC atomic builtins
180320 15:45:24 InnoDB: Compressed tables use zlib 1.2.7
180320 15:45:24 InnoDB: Using Linux native AIO
180320 15:45:24 InnoDB: Initializing buffer pool, size = 128.0M
180320 15:45:24 InnoDB: Completed initialization of buffer pool
180320 14:03:14 [Note] /usr/libexec/mysqld: Shutdown complete
```

ç›®å‰è¿˜ä¸ä¼šé€šè¿‡æ—¥å¿—åˆ†æé€ æˆå´©æºƒçš„æ˜ç¡®çš„å…·ä½“åŸå› . (åªçŸ¥é“å¯èƒ½æ˜¯`180320 14:03:13 [ERROR] mysqld: Out of memory (Needed 128917504 bytes)`å†…å­˜æº¢å‡º)

å…³äºé”™è¯¯åŸå› å¯èƒ½æœ‰ç”¨çš„æ–‡ç« : [MariaDB keeps crashing on some wordpress posts](https://mariadb.com/kb/en/library/mariadb-keeps-crashing-on-some-wordpress-posts/)

### ä¿®å¤æ•°æ®åº“è¡¨

ä¸è¿‡ä¸çŸ¥é“ä¸ºä½•æˆ‘çš„wordpressè¡¨æ€»æ˜¯æŠ¥é”™, å¤§è‡´ä¿¡æ¯å¦‚ä¸‹

```bash
180320 08:26:26 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
180320  8:26:26 [Note] /usr/libexec/mysqld (mysqld 5.5.56-MariaDB) starting as process 4256 ...
180320  8:26:26 InnoDB: The InnoDB memory heap is disabled
180320  8:26:26 InnoDB: Mutexes and rw_locks use GCC atomic builtins
180320  8:26:26 InnoDB: Compressed tables use zlib 1.2.7
180320  8:26:26 InnoDB: Using Linux native AIO
180320  8:26:26 InnoDB: Initializing buffer pool, size = 128.0M
180320  8:26:26 InnoDB: Completed initialization of buffer pool
180320  8:26:26 InnoDB: highest supported file format is Barracuda.
InnoDB: The log sequence number in ibdata files does not match
InnoDB: the log sequence number in the ib_logfiles!
InnoDB: Restoring possible half-written data pages from the doublewrite buffer...
180320  8:26:27  InnoDB: Waiting for the background threads to start
180320  8:26:28 Percona XtraDB (http://www.percona.com) 5.5.52-MariaDB-38.3 started; log sequence number 1635930
180320  8:26:28 [Note] Plugin 'FEEDBACK' is disabled.
180320  8:26:28 [Note] Server socket created on IP: '0.0.0.0'.
180320  8:26:28 [Note] Event Scheduler: Loaded 0 events
180320  8:26:28 [Note] /usr/libexec/mysqld: ready for connections.
Version: '5.5.56-MariaDB'  socket: '/var/lib/mysql/mysql.sock'  port: 3306  MariaDB Server
180320  8:26:37 [ERROR] mysqld: Table './whidy/wp_options' is marked as crashed and should be repaired
180320  8:26:37 [Warning] Checking table:   './whidy/wp_options'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_posts' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_posts'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_term_taxonomy' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_term_taxonomy'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_term_relationships' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_term_relationships'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_postmeta' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_postmeta'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_usermeta' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_usermeta'
180320  8:26:40 [ERROR] mysqld: Table './whidy/wp_comments' is marked as crashed and should be repaired
180320  8:26:40 [Warning] Checking table:   './whidy/wp_comments'
180320  8:44:23 [ERROR] mysqld: Table './whidy/wp_commentmeta' is marked as crashed and should be repaired
180320  8:44:23 [Warning] Checking table:   './whidy/wp_commentmeta'
```

ä¸Šæ¬¡ä¿®å¤è¿‡ä¸€æ¬¡, ä¸ºä½•æ€»ä¼šå‡ºé”™, è™½ç„¶æŸ¥åˆ°ä¿®å¤å‘½ä»¤:

```bash
mysqlcheck -uroot -p --repair --all-databases
```

è¾“å…¥mysqlå¯†ç å®Œæˆä¿®å¤æ“ä½œ, è¿”å›éƒ¨åˆ†ä¿¡æ¯å¦‚ä¸‹

```bash
whidy.wp_commentmeta                               OK
whidy.wp_comments                                  OK
whidy.wp_hmp_playlist                              OK
whidy.wp_links                                     OK
whidy.wp_litespeed_img_optm
note     : The storage engine for the table doesn't support repair
whidy.wp_litespeed_optimizer
note     : The storage engine for the table doesn't support repair
whidy.wp_options                                   OK
whidy.wp_pollsa                                    OK
whidy.wp_pollsip                                   OK
whidy.wp_pollsq                                    OK
whidy.wp_postmeta                                  OK
whidy.wp_posts                                     OK
whidy.wp_postviews_plus                            OK
whidy.wp_term_relationships                        OK
whidy.wp_term_taxonomy                             OK
whidy.wp_termmeta                                  OK
whidy.wp_terms                                     OK
whidy.wp_usermeta                                  OK
whidy.wp_users                                     OK
```

å‚é˜…: [Table is marked as crashed and should be repaired](https://stackoverflow.com/questions/4357270/table-is-marked-as-crashed-and-should-be-repaired)

### æ€»ç»“

å¯¹äºçŸ­æœŸ(çº¦ä¸åˆ°ä¸€å‘¨)å‡ºç°ç¬¬äºŒæ¬¡å´©æºƒæ˜¯ä¸èƒ½æ¥å—çš„, æœ‰äººè¯´**apache2å ç”¨å†…å­˜è¿‡é«˜**(å‚é˜…: [wordpressçš„Error establishing a database connectioné—®é¢˜](http://blog.csdn.net/pyufftj/article/details/52337499)), æˆ‘ä¹Ÿå°šä¸æ˜ç¡®, è€ƒè™‘æ›´æ¢Nginx?

## åšå®¢æ”¹ç”¨Nginx

æ™šä¸Šå›å»æœ¬æ¥ä¸æƒ³å¼€ç”µè„‘, åˆæƒ³ç€å¤ªæ—©äº†, äºæ˜¯å°†Apacheæ›´æ¢ä¸ºNginx, æœ¬æ¥ä¸€ä¸‹å°±å¼„å®Œäº†, æ²¡æƒ³åˆ°è¿˜æ˜¯å¼„äº†å¾ˆä¹…. ä¸€ä¸å°å¿ƒå°±åˆ°äº†11ç‚¹åŠ, æ˜å¤©å†æ€»ç»“ä¸‹ä¸€äº›æ›¿æ¢æ“ä½œæµç¨‹å§.