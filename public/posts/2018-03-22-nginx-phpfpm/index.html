<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Daily note  | Nginx的站点配置/PHP-FPM配置</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Nginx的站点配置/PHP-FPM配置" />
<meta property="og:description" content="2018年3月22日 晴 一般
 Nginx的站点配置/PHP-FPM配置 22号是艰难的一天. 各种爆炸!
Nginx的站点配置  昨晚, 回去看了一下百度统计, 一下子就炸了. 在我还不了解Nginx配置的情况下, 我只是让首页正常访问了&hellip; 其他页面全挂. 于是开始了大量英文资料的阅读.
 以下内容围绕nginx.conf配置文件展开, 也不知道是不是版本区别, 总跟网上的文章有些不一样, 我也陷入迷茫.
我要解决的问题:
 博客所有页面(包括文章伪静态)访问正常; 其他域名(whidy.net, whidy.cn, www.whidy.cn)均需要301转向到www.whidy.net, 避免分权 针对wordpress的相关优化(可选)  那么, 基于Nginx对服务器的管理的研究, 我发现其主要针对不同的站点进行Server Block配置, 而Server Block如何管理, 我查了大量资料, 比如这里有一篇文章摘要
 To begin, we will need to set up the directory that our server blocks will be stored in, as well as the directory that tells Nginx that a server block is ready to serve to visitors." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://daily.whidy.net/posts/2018-03-22-nginx-phpfpm/" />
<meta property="article:published_time" content="2018-03-22T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-03-22T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Nginx的站点配置/PHP-FPM配置">
<meta itemprop="description" content="2018年3月22日 晴 一般
 Nginx的站点配置/PHP-FPM配置 22号是艰难的一天. 各种爆炸!
Nginx的站点配置  昨晚, 回去看了一下百度统计, 一下子就炸了. 在我还不了解Nginx配置的情况下, 我只是让首页正常访问了&hellip; 其他页面全挂. 于是开始了大量英文资料的阅读.
 以下内容围绕nginx.conf配置文件展开, 也不知道是不是版本区别, 总跟网上的文章有些不一样, 我也陷入迷茫.
我要解决的问题:
 博客所有页面(包括文章伪静态)访问正常; 其他域名(whidy.net, whidy.cn, www.whidy.cn)均需要301转向到www.whidy.net, 避免分权 针对wordpress的相关优化(可选)  那么, 基于Nginx对服务器的管理的研究, 我发现其主要针对不同的站点进行Server Block配置, 而Server Block如何管理, 我查了大量资料, 比如这里有一篇文章摘要
 To begin, we will need to set up the directory that our server blocks will be stored in, as well as the directory that tells Nginx that a server block is ready to serve to visitors.">


<meta itemprop="datePublished" content="2018-03-22T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-03-22T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="427">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nginx的站点配置/PHP-FPM配置"/>
<meta name="twitter:description" content="2018年3月22日 晴 一般
 Nginx的站点配置/PHP-FPM配置 22号是艰难的一天. 各种爆炸!
Nginx的站点配置  昨晚, 回去看了一下百度统计, 一下子就炸了. 在我还不了解Nginx配置的情况下, 我只是让首页正常访问了&hellip; 其他页面全挂. 于是开始了大量英文资料的阅读.
 以下内容围绕nginx.conf配置文件展开, 也不知道是不是版本区别, 总跟网上的文章有些不一样, 我也陷入迷茫.
我要解决的问题:
 博客所有页面(包括文章伪静态)访问正常; 其他域名(whidy.net, whidy.cn, www.whidy.cn)均需要301转向到www.whidy.net, 避免分权 针对wordpress的相关优化(可选)  那么, 基于Nginx对服务器的管理的研究, 我发现其主要针对不同的站点进行Server Block配置, 而Server Block如何管理, 我查了大量资料, 比如这里有一篇文章摘要
 To begin, we will need to set up the directory that our server blocks will be stored in, as well as the directory that tells Nginx that a server block is ready to serve to visitors."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://daily.whidy.net" class="f3 fw2 hover-white no-underline white-90 dib">
      Daily note
    </a>
    <div class="flex-l items-center">
      

      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Nginx的站点配置/PHP-FPM配置</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2018-03-22T00:00:00Z">March 22, 2018</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<blockquote>
<p>2018年3月22日 晴 一般</p>
</blockquote>

<h1 id="nginx的站点配置-php-fpm配置">Nginx的站点配置/PHP-FPM配置</h1>

<p>22号是艰难的一天. 各种爆炸!</p>

<h2 id="nginx的站点配置">Nginx的站点配置</h2>

<blockquote>
<p>昨晚, 回去看了一下百度统计, 一下子就炸了. 在我还不了解Nginx配置的情况下, 我只是让首页正常访问了&hellip; 其他页面全挂. 于是开始了大量英文资料的阅读.</p>
</blockquote>

<p>以下内容围绕<code>nginx.conf</code>配置文件展开, 也不知道是不是版本区别, 总跟网上的文章有些不一样, 我也陷入迷茫.</p>

<p>我要解决的问题:</p>

<ol>
<li>博客所有页面(包括文章伪静态)访问正常;</li>
<li>其他域名(<code>whidy.net</code>, <code>whidy.cn</code>, <code>www.whidy.cn</code>)均需要<strong>301转向</strong>到<code>www.whidy.net</code>, 避免分权</li>
<li>针对<code>wordpress</code>的相关优化(可选)</li>
</ol>

<p>那么, 基于<code>Nginx</code>对服务器的管理的研究, 我发现其主要针对不同的站点进行<code>Server Block</code>配置, 而<code>Server Block</code>如何管理, 我查了大量资料, 比如这里有一篇文章摘要</p>

<blockquote>
<p>To begin, we will need to set up the directory that our server blocks will be stored in, as well as the directory that tells Nginx that a server block is ready to serve to visitors. The <code>sites-available</code> directory will keep all of our server block files, while the <code>sites-enabled</code> directory will hold symbolic links to server blocks that we want to publish.</p>
</blockquote>

<p>参阅: <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-server-blocks-on-centos-7">How To Set Up Nginx Server Blocks on CentOS 7</a></p>

<p>简单来说, 他建议在Nginx配置管理目录下创建两个目录, <code>sites-available</code>是用于存放可用的站点配置, <code>sites-enabled</code>则是存放<code>sites-available</code>内的配置软链接过来的, 将要生效在<code>nginx.conf</code>中</p>

<p>先介绍下情况, 我的<code>wordpress</code>位于<code>/var/www/</code>目录下, 那么整个流程如下:</p>

<p>创建刚提到的两个存放站点配置的目录</p>

<pre><code class="language-bash"># mkdir /etc/nginx/sites-available
# mkdir /etc/nginx/sites-enabled
</code></pre>

<p>修改<code>nginx.conf</code>使刚创建的目录内的配置生效</p>

<pre><code class="language-bash"># nano /etc/nginx/nginx.conf
</code></pre>

<p>在<code>http{}</code>块内尾部添加</p>

<pre><code class="language-text">include /etc/nginx/sites-enabled/*.conf;
server_names_hash_bucket_size 64;
</code></pre>

<p>创建<code>wordpress.conf</code>配置文件在<code>sites-available</code>内</p>

<pre><code class="language-bash"># vi /etc/nginx/sites-available/word press.conf
</code></pre>

<p>编辑内容大致如下:</p>

<pre><code class="language-text">server {
    server_name www.whidy.net;
    root /var/www/wordpress;
    index index.php index.html index.htm;

    include /etc/nginx/default.d/*.conf;

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;

        if ($http_host ~* &quot;^(www.)?whidy.cn$&quot;){
            rewrite ^(.*)$ https://www.whidy.net/$1 permanent;
        }
        if ($http_host ~* &quot;^whidy.net$&quot;){
            rewrite ^(.*)$ https://www.whidy.net/$1 permanent;
        }
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires max;
        log_not_found off;
    }

    location ~ /\.ht {
        deny  all;
    }

    gzip on;
    gzip_vary on;
    gzip_comp_level 2;
    gzip_types text/plain text/html text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;
    gzip_proxied any;
    gzip_min_length 1024;
}
</code></pre>

<p>保存好后, 还有件事情就是把<code>nginx.conf</code>文件内的默认<code>server block</code>注释掉, 它会导致wordpress内的301跳转失效. 当然我这分配置的具体说明就不说了, 一时难以讲明白, 建议大家自行谷歌. 也可参考我下面的参阅列表.</p>

<p>接着软链接到<code>sites-enabled</code>使配置生效, 命令如下</p>

<pre><code class="language-bash"># ln -s /etc/nginx/sites-available/wordpress.conf /etc/nginx/sites-enabled/wordpress.conf
</code></pre>

<p>最好重启nginx服务</p>

<pre><code class="language-bash"># systemctl restart nginx
</code></pre>

<p>在浏览器测试一下完美~</p>

<p>参阅:</p>

<ul>
<li>Nginx语法: <a href="http://blog.51cto.com/denglz/1341841">http://blog.51cto.com/denglz/1341841</a></li>
<li>网站跳转: <a href="https://www.digitalocean.com/community/tutorials/how-to-create-temporary-and-permanent-redirects-with-nginx">https://www.digitalocean.com/community/tutorials/how-to-create-temporary-and-permanent-redirects-with-nginx</a></li>
<li>Nginx配置参考学习

<ul>
<li><a href="https://gist.github.com/MaherSaif/1580998">https://gist.github.com/MaherSaif/1580998</a></li>
<li><a href="https://gist.github.com/kjprince/9496501">https://gist.github.com/kjprince/9496501</a></li>
<li><a href="https://codex.wordpress.org/Nginx">wordpress nginx 配置</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/">https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/</a></li>
</ul></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/">Server Block Examples</a></li>
</ul>

<p>不过后台更新插件时又出现了之前发生的问题: <strong>&ldquo;要执行请求的操作，WordPress需要访问您网页服务器的权限。&rdquo;</strong> - -知道是权限问题,却不知道是哪个权限..突然想起nginx的php管理是php-fpm&hellip;</p>

<pre><code class="language-bash"># chown -R php-fpm:php-fpm /var/www/wordpress
</code></pre>

<p>就好了..</p>

<h3 id="配置另一个站点">配置另一个站点</h3>

<p>首先我创建了一个<code>Jekyll</code>站点, 它生成的静态目录在<code>/home/whidy/blog/_site</code>的时候. 而<code>nginx</code>管理网站的目录是<code>/var/www/</code>, 我这里为了方便管理创建了软连接, 如下</p>

<pre><code class="language-bash"># ln -s /home/whidy/blog/_site /var/www/blog
</code></pre>

<p>配置了<code>server block</code>, 如下</p>

<pre><code class="language-txt">server {
    listen 80;
    server_name test.whidy.net;
    root /var/www/blog;
    index index.html index.htm;

    location / {
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
</code></pre>

<p>然后访问网站出现<code>403</code>, 查了很多资料, 不确定是否跟软链接有关, 后来查出来了, 因为我当前运行nginx的用户是<code>nginx</code>(命令查看: <code>ps -ef | grep nginx</code>), 那么<strong>nginx没有权限访问用户whidy的目录及文件</strong>, 本以为给<code>_site</code>目录设置可读就行了, 然后还是<code>403</code>, 为此折腾了很久, 才查到原来同时还<strong>需要给nginx一个可读whidy目录的权限</strong>! 也就是说此时必须同时给<code>/home/whidy/blog/_site</code>(包含_site内的所有文件)和<code>/home/whidy</code>目录可读权限才能正常访问</p>

<pre><code class="language-bash"># chmod +r -R /home/whidy/blog/_site
# chmod +r /home/whidy
</code></pre>

<p>无需重启Nginx服务, 刷新页面然后就好了.</p>

<blockquote>
<p>很奇怪的是, 我假设给blog目录不设置全部可读, 它照样正常. 真是蛋疼~</p>
</blockquote>

<p>相关阅读: <a href="https://www.ibm.com/developerworks/cn/linux/l-cn-hardandsymb-links/index.html">理解 Linux 的硬链接与软链接</a></p>

<h2 id="php-fpm配置">PHP-FPM配置</h2>

<p>我很奇怪, 都说<code>Nginx</code>内存占用比<code>Apache</code>少, 可是自从我换了<code>Nginx</code>后, <code>MariaDB</code>崩溃问题不断, 起初以为是<code>MariaDB</code>的问题, 越发频繁的内存暴增引起我对内存的注意, 于是看看内存使用情况后发现, 存在大量的<code>php-fpm</code>进程, 至少占用了几百兆内存.</p>

<p>查看内存使用情况:</p>

<pre><code class="language-bash"># ps -e -o 'pid,comm,args,pcpu,rsz,vsz,stime,user,uid'
</code></pre>

<p>然后通过搜索<strong>PHP-FPM内存占用</strong>的问题, 网上也有很多, 默认状态下它会动态分配很多子进程, 这有篇文章简单介绍了一下<a href="https://www.jianshu.com/p/9450ab506446">nginx+php-fpm模式php内存泄漏探究</a>, 那么解决占用内存的方法看来只有从PHP-FPM配置文件上下手了.</p>

<p>谷歌了相关资料, 目前经测试比较好用的方法就是修改文件</p>

<pre><code class="language-bash"># vi /etc/php-fpm.d/www.conf
</code></pre>

<p>找到<code>pm = dynamic</code>(默认值), 改成<code>pm = ondemand</code>, 以及<code>pm.process_idle_timeout = 10s</code>去掉注释, 保存并重启服务</p>

<pre><code class="language-bash"># systemctl restart php-fpm
</code></pre>

<p>经过两天的观察, 内存使用稳定在300M以内, 比较满意了. 不过为什么会内存溢出呢, 真是不稳定哎~</p>

<p>参阅: <a href="http://linuxbsdos.com/2015/02/17/how-to-reduce-php-fpm-php5-fpm-ram-usage-by-about-50/">How to reduce PHP-FPM (php5-fpm) RAM usage by about 50%</a></p>

<blockquote>
<p>完成22号的日志现在已经是 3-23 23:56, 最近实在是太忙了. 昨晚小程序上线出BUG, 搞到快晚上11点才回去, 也有些经验要总结. 今天先到这吧</p>
</blockquote>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://daily.whidy.net" >
    &copy; 2019 Daily note
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
